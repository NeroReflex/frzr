#! /bin/bash

set -e

# import methods
source "${BASH_SOURCE%/*}/__frzr" "$@"

if [ $EUID -ne 0 ]; then
	echo "$(basename $0) must be run as root"
	exit 1
fi

DEPLOYMENT=$(frzr-release)
if echo "${DEPLOYMENT}" | grep -Fq 'ERROR'; then
	echo "frzr-unlock failed: not currently running a from frzr deployment"
	exit 1
else
	# set rootfs btrfs subvolume to read-write mode
	UNLOCK_RESULT=$(btrfs_subvolume_set_rw "/")
	if echo "${UNLOCK_RESULT}" | grep -q 'OK'; then
		systemctl daemon-reload

		echo "frzr deployment ${DEPLOYMENT} unlock succeeded"
	else
		echo "frzr deployment ${DEPLOYMENT} unlock failed: cannot set subvolume to r/w"
		exit 1
	fi
else
